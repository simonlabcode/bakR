<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Fit 'Stan' models to nucleotide recoding RNA-seq data analysis — TL_stan • bakR</title><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet"><link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet"><script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Fit 'Stan' models to nucleotide recoding RNA-seq data analysis — TL_stan"><meta name="description" content="TL_stan is an internal function to analyze nucleotide recoding RNA-seq data with a fully
Bayesian hierarchical model implemented in the PPL Stan. TL_stan estimates
kinetic parameters and differences in kinetic parameters between experimental
conditions. When assessing differences, a single reference sample is compared to
each collection of experimental samples provided."><meta property="og:description" content="TL_stan is an internal function to analyze nucleotide recoding RNA-seq data with a fully
Bayesian hierarchical model implemented in the PPL Stan. TL_stan estimates
kinetic parameters and differences in kinetic parameters between experimental
conditions. When assessing differences, a single reference sample is compared to
each collection of experimental samples provided."><meta property="og:image" content="https://simonlabcode.github.io/bakR/logo.png"></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">bakR</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.0.1</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="active nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles"><li><a class="dropdown-item" href="../articles/Getting-Started.html">Differential kinetic analysis with bakR</a></li>
    <li><a class="dropdown-item" href="../articles/bakR-Quickstart.html">bakR for people in a hurry</a></li>
    <li><a class="dropdown-item" href="../articles/Differential-Synth.html">Differential synthesis analysis with bakR and DESeq2</a></li>
    <li><a class="dropdown-item" href="../articles/bakR-Fn.html">GRAND-SLAM output/fn estimates as bakR input</a></li>
    <li><a class="dropdown-item" href="../articles/Dropout.html">Correcting for dropout</a></li>
    <li><a class="dropdown-item" href="../articles/Troubleshooting.html">Troubleshooting analyses of NR-seq data with bakR</a></li>
    <li><a class="dropdown-item" href="../articles/NSS.html">Steady-state quasi-independent mechanistic investigations</a></li>
  </ul></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json"></form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/simonlabcode/bakR/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul></div>


  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Fit 'Stan' models to nucleotide recoding RNA-seq data analysis</h1>
      <small class="dont-index">Source: <a href="https://github.com/simonlabcode/bakR/blob/master/R/TL_stan.R" class="external-link"><code>R/TL_stan.R</code></a></small>
      <div class="d-none name"><code>TL_stan.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p><code>TL_stan</code> is an internal function to analyze nucleotide recoding RNA-seq data with a fully
Bayesian hierarchical model implemented in the PPL <code>Stan</code>. <code>TL_stan</code> estimates
kinetic parameters and differences in kinetic parameters between experimental
conditions. When assessing differences, a single reference sample is compared to
each collection of experimental samples provided.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">TL_stan</span><span class="op">(</span></span>
<span>  <span class="va">data_list</span>,</span>
<span>  Hybrid_Fit <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  keep_fit <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  NSS <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  chains <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  <span class="va">...</span></span>
<span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>


<dl><dt id="arg-data-list">data_list<a class="anchor" aria-label="anchor" href="#arg-data-list"></a></dt>
<dd><p>List to pass to 'Stan' of form given by <code>cBprocess</code></p></dd>


<dt id="arg-hybrid-fit">Hybrid_Fit<a class="anchor" aria-label="anchor" href="#arg-hybrid-fit"></a></dt>
<dd><p>Logical; if TRUE, Hybrid 'Stan' model that takes as data output of <code>fast_analysis</code> is run.</p></dd>


<dt id="arg-keep-fit">keep_fit<a class="anchor" aria-label="anchor" href="#arg-keep-fit"></a></dt>
<dd><p>Logical; if TRUE, 'Stan' fit object is included in output; typically large file so default FALSE.</p></dd>


<dt id="arg-nss">NSS<a class="anchor" aria-label="anchor" href="#arg-nss"></a></dt>
<dd><p>Logical; if TRUE, models that directly compare logit(fn)s are used to avoid steady-state assumption</p></dd>


<dt id="arg-chains">chains<a class="anchor" aria-label="anchor" href="#arg-chains"></a></dt>
<dd><p>Number of Markov chains to sample from. The default is to only run a single chain. Typical NR-seq datasets
yield very memory intensive analyses, but running a single chain should decrease this burden. For reference, running
the MCMC implementation (Hybrid_Fit = FALSE) with 3 chains on an NR-seq dataset with 3 replicates of 2 experimental conditions
with around 20 million raw (unmapped) reads per sample requires over 100 GB of RAM. With a single chain, this burden drops to
around 20 GB. Due to memory demands and time constraints (runtimes for the MCMC implementation border will likely be around 1-2 days)
means that these models should usually be run in a specialized High Performance Computing (HPC) system.</p></dd>


<dt id="arg--">...<a class="anchor" aria-label="anchor" href="#arg--"></a></dt>
<dd><p>Arguments passed to <code><a href="https://mc-stan.org/rstan/reference/stanmodel-method-sampling.html" class="external-link">rstan::sampling</a></code> (e.g. iter, warmup, etc.).</p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="value">Value<a class="anchor" aria-label="anchor" href="#value"></a></h2>
    <p>A list of objects:</p><ul><li><p>Effects_df; dataframe with estimates of the effect size (change in logit(fn)) comparing each experimental condition to the
reference sample for each feature. This dataframe also includes p-values obtained from a moderated t-test. The columns of this
dataframe are:</p><ul><li><p>Feature_ID; Numerical ID of feature</p></li>
<li><p>Exp_ID; Numerical ID for experimental condition (Exp_ID from metadf)</p></li>
<li><p>L2FC_kdeg; L2FC(kdeg) posterior mean</p></li>
<li><p>L2FC_kd_sd; L2FC(kdeg) posterior sd</p></li>
<li><p>effect; identical to L2FC_kdeg (kept for symmetry with MLE fit output)</p></li>
<li><p>se; identical to L2FC_kd_sd (kept for symmetry with MLE fit output)</p></li>
<li><p>XF; Feature name</p></li>
<li><p>pval; p value obtained from effect and se + z-test</p></li>
<li><p>padj; p value adjusted for multiple testing using Benjamini-Hochberg procedure</p></li>
</ul></li>
<li><p>Kdeg_df; dataframe with estimates of the kdeg (RNA degradation rate constant) for each feature, averaged across replicate data.
The columns of this dataframe are:</p><ul><li><p>Feature_ID; Numerical ID of feature</p></li>
<li><p>Exp_ID; Numerical ID for experimental condition</p></li>
<li><p>kdeg; Degradation rate constant posterior mean</p></li>
<li><p>kdeg_sd; Degradation rate constant posterior standard deviation</p></li>
<li><p>log_kdeg; Log of degradation rate constant posterior mean (as of version 1.0.0)</p></li>
<li><p>log_kdeg_sd; Log of degradation rate constant posterior standard deviation (as of version 1.0.0)</p></li>
<li><p>XF; Original feature name</p></li>
</ul></li>
<li><p>Fn_Estimates; dataframe with estimates of the logit(fraction new) for each feature in each replicate.
The columns of this dataframe are:</p><ul><li><p>Feature_ID; Numerical ID for feature</p></li>
<li><p>Exp_ID; Numerical ID for experimental condition (Exp_ID from metadf)</p></li>
<li><p>Replicate; Numerical ID for replicate</p></li>
<li><p>logit_fn; Logit(fraction new) posterior mean</p></li>
<li><p>logit_fn_se; Logit(fraction new) posterior standard deviation</p></li>
<li><p>sample; Sample name</p></li>
<li><p>XF; Original feature name</p></li>
</ul></li>
<li><p>Fit_Summary; only outputted if keep_fit == FALSE. Summary of 'Stan' fit object with each row corresponding to a particular
parameter. All posterior point descriptions are descriptions of the marginal posterior distribution for the parameter in that row.
For example, the posterior mean is the average value for the parameter when averaging over all other parameter values.
The columns of this dataframe are:</p><ul><li><p>mean; Posterior mean for the parameter given by the row name</p></li>
<li><p>se_mean; Standard error of the posterior mean; essentially how confident the model is that what it estimates to be the
posterior mean is what the posterior mean actually is. This will depend on the number of chains run on the number of iterations
each chain is run for.</p></li>
<li><p>sd; Posterior standard deviation</p></li>
<li><p>2.5%; 2.5th percentile of the posterior distribution. 2.5% of the posterior mass is below this point</p></li>
<li><p>25%; 25th percentile of the posterior distribution</p></li>
<li><p>50%; 50th percentile of the posterior distribution</p></li>
<li><p>75%; 75th percentile of the posterior distribution</p></li>
<li><p>97.5%; 97.5th percentile of the posterior distribution</p></li>
<li><p>n_eff; Effective sample size. The larger this is the better, though it should preferably be around the total number of
iterations (iter x chains). Small values of this could represent poor model convergence</p></li>
<li><p>Rhat; Describes how well separate Markov chains mixed. This is preferably as close to 1 as possible, and values higher
than 1 could represent poor model convergence</p></li>
</ul></li>
<li><p>Stan_Fit; only outputted if keep_fit == TRUE. This is the full 'Stan' fit object, an R6 object of class <code>stanfit</code></p></li>
<li><p>Mutation_Rates; data frame with information about mutation rate estimates. Has the same columns as Fit_Summary.
Each row corresponds to either a background mutation rate (log_lambda_o) or an s4U induced mutation rate (log_lambda_n),
denoted in the parameter column. The bracketed portion of the parameter name will contain two numbers. The first corresponds
to the Exp_ID and the second corresponds to the Replicate_ID. For example, if the parameter name is log_lambda_o[1,2] then
that row corresponds to the background mutation rate in the second replicate of experimental condition one. A final point to
mention is that the estimates are on a log(avg. # of mutations) scale. So a log_lambda_n of 1 means that on average, there
are an estimated 2.72 (exp(1)) mutations in reads from new RNA (i.e., RNA synthesized during s4U labeling).</p></li>
</ul></div>
    <div class="section level2">
    <h2 id="details">Details<a class="anchor" aria-label="anchor" href="#details"></a></h2>
    <p>Two implementations of a similar model can be fit with TL_stan: a complete nucleotide recoding RNA-seq
analysis and a hybrid analysis that takes as input results from <code>fast_analysis</code>.
In the complete analysis (referred to in the bakR publication as the MCMC implementation),
U-to-C mutations are modeled as coming from a Poisson distribution
with rate parameter adjusted by the empirical U-content of each feature analyzed. Features
represent whatever the user defined them to be when constructing the bakR data object.
Typical feature categories are genes, exons, etc. Hierarchical modeling is used to pool data
across replicates and across features. More specifically, replicate data for the
same feature are partially pooled to estimate feature-specific mean fraction news and uncertainties.
Feature means are partially pooled to estimate dataset-wide mean fraction news and standard deviations.
The replicate variability for each feature is also partially pooled to determine a condition-wide
heteroskedastic relationship between read depths and replicate variability. Partial pooling
reduces subjectivity when determining priors by allowing the model to determine what priors make sense
given the data. Partial pooling also regularizes estimates, reducing estimate variability and thus increasing
estimate accuracy. This is particularly important for replicate variability estimates, which often rely
on only a few replicates of data per feature and thus are typically highly unstable.</p>
<p>The hybrid analysis (referred to in the bakR publication as the Hybrid implementation)
inherits the hierarchical modeling structure of the complete analysis, but reduces computational
burden by foregoing per-replicate-and-feature fraction new estimation and uncertainty quantification. Instead,
the hybrid analysis takes as data fraction new estimates and approximate uncertainties from <code>fast_analysis</code>.
Runtimes of the hybrid analysis are thus often an order of magnitude shorter than with the complete analysis, but
loses some accuracy by relying on point estimates and uncertainty quantification that is only valid in the
limit of large dataset sizes (where the dataset size for the per-replicate-and-feature fraction new estimate is the raw number
of sequencing reads mapping to the feature in that replicate).</p>
<p>Users also have the option to save or discard the <code>Stan</code> fit object. Fit objects can be exceedingly large (&gt; 10 GB) for most
nucleotide recoding RNA-seq datasets. Therefore, if you don't want to store such a large object, a summary object will be saved instead,
which greatly reduces the size of the output (~ 10-50 MB) while still retaining much of the important information. In addition,
the output of <code>TL_stan</code> provides the estimates and uncertainties for key parameters (L2FC(kdeg), kdeg, and fraction new)
that will likely be of most interest. That being said, there are some analyses that are only possible if the original fit object
is saved. For example, the fit object will contain all of the samples from the posterior collected during model fitting. Thus,
new parameters (e.g., L2FC(kdeg)'s comparing two experimental samples) not naturally generated by the model can be estimated
post-hoc. Still, there are often approximate estimates that can be obtained for such parameters that don't rely on the full
fit object. One analysis that is impossible without the original fit object is generating model diagnostic plots. These include
trace plots (to show mixing and efficient parameter space exploration of the Markov chains), pairs plots (to show correlations
between parameters and where any divergences occurred), and other visualizations that can help users assess how well a model
ran. Because the models implemented by <code>TL_stan</code> are extensively validated, it is less likely that such diagnostics will be helpful,
but often anomalies on your data can lead to poor model convergence, in which case assessing model diagnostics can help you
identify the source of problems in your data. Summary statistics describing how well the model was able to estimate each parameter
(n_eff and rhat) are provided in the fit summaries, but can often obscure some of the nuanced details of model fitting.</p>
    </div>

  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Isaac Vock.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer></div>





  </body></html>

